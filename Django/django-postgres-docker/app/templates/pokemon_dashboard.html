{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Pokedex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'styles/app.css' %}">
    <link rel="icon" href="{% static 'media/PokeballIcon.png' %}">
</head>

<body>
    {% include 'navbar.html' %}
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Pokedex</h2>
            <button id="tema-btn" onclick="toggleDarkMode()" class="btn btn-secondary">üåô Tema</button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>¬°Bienvenido, {{ usuario.nombre }}!</h4>
            <div>
                <a href="/" class="btn btn-primary">Volver al inicio</a>
                <a href="/logout" class="btn btn-danger">Cerrar Sesi√≥n</a>
            </div>

        </div>

        <!-- B√∫squeda (solo visual) -->
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Buscar pokemon... (no funcional)">
            <button class="btn btn-outline-secondary" type="button" disabled>üîç</button>
        </div>

        <!-- Cuadr√≠cula de pokemon -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-4">
            {% for poke in pokemon %}
            <div class="col pokemon-link">
                <a href="{% url 'pokemon_detalle' poke.id %}" style="text-decoration: none; color: inherit;">
                    <div class="card h-100 book-card shadow-sm">
                        <img src="{{ poke.image }}" class="card-img-top book-cover" alt="Img Pokemon">
                        <div class="card-body">
                            <h5 class="card-title">N.¬∫ {{ poke.id }}: {{ poke.name|capfirst }}</h5>
                            <p class="card-text">
                                Tipos:
                                {% for tipo in poke.types %}
                                <span class="badge" style="background-color: var(--{{ tipo }});">{{ tipo }}</span>
                                {% endfor %}
                            </p>
                            <div class="botones-pokemon-grid mt-2">
                            </a>
                                <button class="btn btn-warning btn-sm btn-fav" data-pokeid="{{ poke.id }}"
                                    title="Favorito">
                                    {% if poke.id|stringformat:"s" in usuario.favoritos %}
                                    ‚òÖ
                                    {% else %}
                                    ‚òÜ
                                    {% endif %}
                                </button>
                                <button class="btn btn-success btn-sm btn-agregar-equipo" data-pokeid="{{ poke.id }}"
                                    data-pokename="{{ poke.name|capfirst }}" data-bs-toggle="modal"
                                    data-bs-target="#modalAgregarEquipo">
                                    Agregar a Equipo
                                </button>
                            </div>
                        </div>
                    </div>
            </div>
            {% empty %}
            <div class="col-12 text-center">
                <p>No hay pokemon disponibles.</p>
            </div>
            {% endfor %}
        </div>

        <div class="botones-paginacion">
            {% if prev_offset is not None %}
            <a href="?offset={{ prev_offset }}" class="btn btn-primary">Anterior</a>
            {% endif %}
            {% if next_offset is not None %}
            <a href="?offset={{ next_offset }}" class="btn btn-primary">Siguiente</a>
            {% endif %}
        </div>

    </div>

    <!-- Modal para agregar a equipo -->
    <div class="modal fade" id="modalAgregarEquipo" tabindex="-1" aria-labelledby="modalAgregarEquipoLabel"
        aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="form-agregar-equipo">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarEquipoLabel">Agregar a Equipo</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="poke_id" id="modal-poke-id">
                        <div class="mb-3">
                            <label for="equipo-select" class="form-label">Selecciona un equipo</label>
                            <select class="form-select" id="equipo-select" name="equipo_id">
                                {% if usuario.equipos.all %}
                                {% for equipo in usuario.equipos.all %}
                                <option value="{{ equipo.id }}">{{ equipo.nombre }} ({{ equipo.pokemones|length }}/6)
                                </option>
                                {% endfor %}
                                {% else %}
                                <option value="" disabled selected>No tienes equipos a√∫n</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="nuevo-equipo" class="form-label">O crea un nuevo equipo</label>
                            <input type="text" class="form-control" id="nuevo-equipo" name="nuevo_equipo"
                                placeholder="Nombre del nuevo equipo">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        let equipoSelect = document.getElementById('equipo-select');
        let nuevoEquipoInput = document.getElementById('nuevo-equipo');
        let pokeIdInput = document.getElementById('modal-poke-id');

        // Cuando se abre el modal, coloca el poke_id
        $('.btn-agregar-equipo').click(function () {
            let pokeId = $(this).data('pokeid');
            let pokeName = $(this).data('pokename');
            $('#modal-poke-id').val(pokeId);
            $('#modalAgregarEquipoLabel').text('Agregar a ' + pokeName + ' al equipo');
        });

        // Al enviar el formulario
        $('#form-agregar-equipo').submit(function (e) {
            e.preventDefault();
            let poke_id = $('#modal-poke-id').val();
            let equipo_id = $('#equipo-select').val();
            let nuevo_equipo = $('#nuevo-equipo').val();

            if (!equipo_id && !nuevo_equipo) {
                alert('Selecciona un equipo o ingresa un nombre para crear uno nuevo.');
                return;
            }

            $.post("{% url 'agregar_a_equipo' %}", {
                poke_id: poke_id,
                equipo_id: equipo_id,
                nuevo_equipo: nuevo_equipo,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function (data) {
                if (data.success) {
                    if (nuevo_equipo) {
                        // Si se cre√≥ un nuevo equipo, recarga la p√°gina
                        alert('¬°Pok√©mon agregado al nuevo equipo!');
                        location.reload();
                    } else {
                        alert('¬°Pok√©mon agregado al equipo!');
                        location.reload();
                    }
                } else {
                    alert(data.error || 'Ocurri√≥ un error');
                }
            });
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('tema-btn');
            if (document.body.classList.contains('dark-mode')) {
                btn.innerHTML = '‚òÄÔ∏è Tema';
            } else {
                btn.innerHTML = 'üåô Tema';
            }
        }

        $('.btn-fav').click(function (e) {
            e.preventDefault();
            var btn = $(this);
            var poke_id = btn.data('pokeid');
            $.post("{% url 'toggle_favorito' %}", {
                poke_id: poke_id,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }, function (data) {
                if (data.success) {
                    if (data.action === 'added') {
                        btn.html('‚òÖ');
                    } else {
                        btn.html('‚òÜ');
                    }
                }
            });
        });
    </script>
</body>

</html>